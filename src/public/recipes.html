<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recipes ‚Ä¢ Arogya</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root {
      /* Recipe card background color from Meal Plan */
      --beige: #F1DABF; 
    }
    /* Add basic styling for the modal from Meal Plan for consistency */
    .modal-wrap { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: flex-start; justify-content: center; z-index: 1000; padding-top: 5rem; }
    .modal-backdrop { position: absolute; inset: 0; }
    .modal { background: var(--cream); border-radius: 1rem; box-shadow: 0 10px 20px rgba(0,0,0,0.2); max-width: 40rem; width: 90%; max-height: 80vh; overflow-y: auto; padding: 1.5rem; position: relative; }
    .modal-close { position: absolute; top: 0.5rem; right: 1rem; font-size: 2rem; color: var(--peach); background: none; border: none; cursor: pointer; }
    .modal-title { font-size: 1.75rem; font-weight: bold; margin-bottom: 0.75rem; color: var(--teal); }
    .modal-img { width: 100%; height: 12rem; object-fit: cover; border-radius: 0.75rem; margin-bottom: 1rem; background: var(--sage-300); }
    .modal-meta { font-size: 0.875rem; color: #4b5563; margin-bottom: 1.5rem; }
    .modal-section { margin-top: 1.5rem; }
    .modal-subtitle { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--teal); }
    .modal-list { list-style: disc; margin-left: 1.25rem; font-size: 0.9375rem; color: #374151; }
    .modal-list.numbered { list-style: decimal; }
    .notes { font-style: italic; font-size: 0.875rem; color: #4b5563; padding: 0.5rem; border-left: 3px solid var(--sage); background: var(--sage-100); }
  </style>
</head>
<body class="bg-[var(--cream)] text-[var(--teal)] font-sans">

  <header class="bg-[var(--teal)] fixed w-full top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-white">Arogya</h1>
      <nav class="flex items-center space-x-4">
        <a href="/dashboard.html" class="text-white font-medium hover:text-[var(--sage)] transition-colors">Dashboard</a>
        <a href="/mealplan.html" class="text-white font-medium hover:text-[var(--sage)] transition-colors">Meal Plan</a>
        <a class="text-[var(--sage)] font-semibold" href="/recipes.html">Recipes</a>
        <button id="logoutBtn" class="bg-[var(--peach)] px-4 py-2 rounded-lg text-white font-semibold hover:bg-opacity-90">
          Logout
        </button>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto pt-28 pb-16 px-6">
    <h1 class="text-3xl font-bold mb-8 text-[var(--teal)] text-center">Explore Our Delicious Recipes</h1>
    <div id="recipes-status" class="text-center text-gray-700 mb-4"></div>

    <div id="recipes-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

    <div class="flex justify-center mt-8">
      <button id="load-more" class="hidden bg-[var(--peach)] text-white px-5 py-2 rounded-lg font-semibold hover:bg-opacity-90">Load More</button>
    </div>
  </main>

  <footer class="bg-[var(--teal)] text-white py-6 mt-12 text-center">
    &copy; 2025 Arogya
  </footer>

  <script>
    // CONFIG
    const API_BASE = 'http://localhost:4000';
    const IMG_BASE = '/images/';
    const PLACEHOLDER = 'https://via.placeholder.com/600x400?text=Recipe';
    const grid = document.querySelector('#recipes-grid');
    const statusEl = document.querySelector('#recipes-status');
    const loadMoreBtn = document.querySelector('#load-more');

    // AUTH
    const sessionUser = JSON.parse(localStorage.getItem('loggedInUser'));
    const token = localStorage.getItem('token');
    if (!sessionUser) window.location.href = '/login.html';
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('loggedInUser'); localStorage.removeItem('token');
      window.location.href = '/login.html';
    });

    // HELPERS (Matching Meal Plan Helpers)
    const toTitle = s => String(s||'').replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
    const clean = s => String(s||'').replace(/\*\*([^*]+)\*\*/g, (_,m)=>m.replace(/_/g,' ')); // Used by Meal Plan for steps/notes

    // PAGINATION
    const seenSlugs = new Set();
    let skip = 0;
    const LIMIT = 12;
    let total = null;

    // CARD TEMPLATE (Adjusted for "View Recipe" placement)
    function cardTpl(item) {
      const imgSrc = item.image_url ? `${IMG_BASE}${item.image_url}` : PLACEHOLDER;
      const tags = (item.tags || []).slice(0, 3).map(
        t=>`<span class="inline-block bg-[var(--sage)] text-[var(--teal)] text-[11px] font-semibold px-2 py-1 rounded-full mr-1 mb-1">${t}</span>`
      ).join(' ');
      
      return `
        <article class="bg-[var(--beige)] border border-[var(--sage)] rounded-2xl overflow-hidden flex flex-col shadow-sm hover:shadow-md transition-shadow">
          <img class="w-full h-40 object-cover bg-[var(--sage)]/30" src="${imgSrc}" alt="${item.recipe_name}" loading="lazy">
          <div class="p-4 flex flex-col gap-3 flex-1">
            <div>
              <h3 class="text-lg font-bold tracking-tight">${toTitle(item.meal_type)}: ${item.recipe_name}</h3>
              <div class="flex flex-wrap gap-2 text-sm text-[color:var(--ink-700)] mt-1.5">
                <span>${item.calories} kcal</span>
                ${Number.isFinite(item.protein) ? `<span>${item.protein} g protein</span>` : ``}
                ${Number.isFinite(item.carbs)   ? `<span>${item.carbs} g carbs</span>`   : ``}
                ${Number.isFinite(item.fats)    ? `<span>${item.fats} g fat</span>`      : ``}
                <span>${item.time_minutes} min</span>
                <span>${item.dietaryType || '-'}</span>
              </div>
              ${tags ? `<div class="mt-2">${tags}</div>` : ``}
            </div>
            <div class="mt-auto">
              <a class="w-full bg-[var(--peach)] text-white py-2 rounded-lg font-semibold shadow hover:bg-opacity-90 transition view-btn text-center" href="#" data-slug="${item.slug}">
                View Recipe
              </a>
            </div>
          </div>
        </article>`;
    }

    async function loadPage(){
      statusEl.textContent = skip === 0 ? 'Loading recipes‚Ä¶' : 'Loading more‚Ä¶';
      const res = await fetch(`${API_BASE}/api/recipes?limit=${LIMIT}&skip=${skip}`, {
        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
      });
      const data = await res.json().catch(()=>({ ok:false }));
      if(!data.ok){ statusEl.textContent = 'Error loading recipes.'; return; }

      if (total == null) total = data.total ?? null;
      const fresh = (data.items || []).filter(it => {
        if (!it.slug) return true;
        if (seenSlugs.has(it.slug)) return false;
        seenSlugs.add(it.slug);
        return true;
      });

      if (fresh.length){
        const html = fresh.map(cardTpl).join('');
        grid.insertAdjacentHTML('beforeend', html);
        skip += fresh.length;
        statusEl.textContent = '';
        updateLoadMore(fresh.length);
      } else {
        if (skip === 0) statusEl.textContent = 'No recipes found.';
        updateLoadMore(0, true);
      }
    }

    function updateLoadMore(lastCount, forceDone=false){
      const done = forceDone || (total != null ? skip >= total : lastCount < LIMIT);
      loadMoreBtn.classList.toggle('hidden', done);
    }

    loadMoreBtn.addEventListener('click', ()=>loadPage().catch(err=>{
      console.error(err); statusEl.textContent = 'Failed to load more.';
    }));

    // MODAL FUNCTION 
    function lockScroll(lock){ document.body.style.overflow = lock ? 'hidden' : ''; }
    function showRecipeModal({title, img, meta, ingredientsHtml, stepsHtml, notes}){
      const html = `
        <div class="modal-backdrop"></div>
        <div class="modal" role="dialog" aria-modal="true" aria-label="${title}">
          <button class="modal-close" aria-label="Close recipe">√ó</button>
          <h2 class="modal-title">${title}</h2>
          <img class="modal-img" src="${img}" alt="${title}">
          <p class="modal-meta">${meta}</p>

          <div class="modal-section">
            <h3 class="modal-subtitle">ü•ó Ingredients</h3>
            <ul class="modal-list">${ingredientsHtml}</ul>
          </div>

          <div class="modal-section">
            <h3 class="modal-subtitle">üë©‚Äçüç≥ Steps</h3>
            <ol class="modal-list numbered">${stepsHtml}</ol>
          </div>

          ${notes ? `<div class="modal-section">${notes}</div>` : ''}
        </div>`;
      const wrap = document.createElement('div');
      wrap.className = 'modal-wrap';
      wrap.innerHTML = html;
      document.body.appendChild(wrap);
      lockScroll(true);

      const close = () => { wrap.remove(); lockScroll(false); };
      wrap.querySelector('.modal-close').onclick = close;
      wrap.querySelector('.modal-backdrop').onclick = close;
      document.addEventListener('keydown', function esc(e){
        if(e.key === 'Escape'){ close(); document.removeEventListener('keydown', esc); }
      });
    }

    // EVENT LISTENER 
    grid.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.view-btn');
      if(!btn) return;
      e.preventDefault();

      const slug = btn.dataset.slug;
      statusEl.textContent = 'Fetching recipe details...';

      const r = await fetch(`${API_BASE}/api/recipes/${encodeURIComponent(slug)}`, {
        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
      });
      const d = await r.json().catch(()=>({ ok:false }));
      statusEl.textContent = ''; 

      if(!d.ok || !d.item){ alert('Recipe not found.'); return; }
      const item = d.item;

      // Ingredient processing: Simple list without dynamic substitutions/cautions
      const ing = (item.ingredients||[]).map(i=>{
        const qty  = i.quantity ? `<strong>${i.quantity}</strong> ` : '';
        const name = toTitle(i.slug);
        return `<li>${qty}${name}</li>`;
      }).join('');

      const steps = (item.steps||[]).map(s=>`<li>${clean(s)}</li>`).join('');
      const notes = item.notes ? `<p class="notes">${clean(item.notes)}</p>` : '';
      const imgSrc = item.image_url ? `${IMG_BASE}${item.image_url}` : PLACEHOLDER;

      showRecipeModal({
        title: item.recipe_name,
        img: imgSrc,
        meta: `<strong>${item.calories} kcal</strong> ‚Ä¢ ${item.protein ?? '-'} g protein ‚Ä¢ ${item.carbs ?? '-'} g carbs ‚Ä¢ ${item.fats ?? '-'} g fat ‚Ä¢ ${item.time_minutes} min ‚Ä¢ ${item.dietaryType || ''}`,
        ingredientsHtml: ing,
        stepsHtml: steps,
        notes
      });
    });

    // INITIAL LOAD
    loadPage().catch(err=>{
      console.error(err);
      statusEl.textContent = 'Failed to load recipes. Is the API running?';
    });
  </script>
</body>
</html>