<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meal Plan ‚Ä¢ Arogya</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles.css">

  <style>
    :root {
      --beige: #F1DABF; 
      --mint-green: #B4D9BB; 
    }
  </style>
</head>
<body class="bg-[var(--cream)] text-[var(--teal)] font-sans">

  <header class="bg-[var(--teal)] fixed w-full top-0 z-50 shadow-md shadow-black/10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="text-2xl font-bold text-white tracking-wide">Arogya</div>
      <nav class="flex items-center gap-4">
        <a href="/dashboard.html" class="text-white/90 hover:text-[var(--sage)] transition-colors">Dashboard</a>
        <a class="text-[var(--sage)] font-semibold" href="/mealplan.html">Meal Plan</a>
        <a href="/recipes.html" class="text-white/90 hover:text-[var(--sage)] transition-colors">Recipes</a>
        <button id="logoutBtn" class="bg-[var(--peach)] px-4 py-2 rounded-lg text-white font-semibold shadow hover:bg-opacity-90">
          Logout
        </button>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto pt-28 pb-16 px-6">
    <h1 class="text-3xl md:text-4xl font-extrabold mb-6 text-center tracking-tight">Your Meal Plan</h1>

    <section id="summary" class="mb-6"></section>

    <section>
      <div id="plan-grid" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>

      <div class="flex flex-wrap justify-center gap-3 mt-6">
        <button id="generateBtn" class="bg-[var(--peach)] text-white px-4 py-2 rounded-lg font-semibold shadow hover:bg-opacity-90">
          üîÅ Generate New Meal Plan
        </button>
        <button id="swapBreakfast" class="px-4 py-2 rounded-lg font-semibold border border-[var(--sage)] bg-[var(--beige)] hover:bg-[var(--sage)]/40">
          Change Breakfast
        </button>
        <button id="swapLunch" class="px-4 py-2 rounded-lg font-semibold border border-[var(--sage)] bg-[var(--beige)] hover:bg-[var(--sage)]/40">
          Change Lunch
        </button>
        <button id="swapSnack" class="px-4 py-2 rounded-lg font-semibold border border-[var(--sage)] bg-[var(--beige)] hover:bg-[var(--sage)]/40">
          Change Snack
        </button>
        <button id="swapDinner" class="px-4 py-2 rounded-lg font-semibold border border-[var(--sage)] bg-[var(--beige)] hover:bg-[var(--sage)]/40">
          Change Dinner
        </button>
      </div>

      <div id="plan-status" class="text-center text-[color:var(--ink-700)] mt-3"></div>
    </section>
  </main>

  <footer class="bg-[var(--teal)] text-white py-6 text-center">
    &copy; 2025 Arogya
  </footer>

  <script>
  const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? 'http://localhost:4000'
  : location.origin;
const MEALPLAN_URL = API_BASE + '/api/mealplan';
const IMG_BASE = '/images/';

    const user = JSON.parse(localStorage.getItem('loggedInUser'));
    const token = localStorage.getItem('token');
    if (!user) { alert('Please log in first!'); window.location.href = '/login.html'; }

    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('loggedInUser'); localStorage.removeItem('token');
      window.location.href = '/login.html';
    });

    const summaryEl = document.getElementById('summary');
    const gridEl = document.getElementById('plan-grid');
    const statusEl = document.getElementById('plan-status');

    let lastPlan = null;

    const clean = s => String(s||'').replace(/\*\*([^*]+)\*\*/g, (_,m)=>m.replace(/_/g,' '));
    const toTitle = s => String(s||'').replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());

    function getTargetsFromProfile(){
      const p = (user && user.profile) ? user.profile : {};
      const kcal    = Math.round(Number(p.calories || 0));
      const protein = Math.round(Number(p.protein  || 0));
      const macros  = p.macros || {};
      const carbs   = Math.round(Number(macros.carbs?.grams || 0));
      const fat     = Math.round(Number(macros.fat?.grams   || 0));
      return { kcal, protein, carbs, fat };
    }

    function computePlanTotals(data){
      const slots = ['Breakfast','Lunch','Snack','Dinner'];
      let kcal=0, protein=0, carbs=0, fat=0;
      slots.forEach(s=>{
        const r = data?.mealPlan?.[s]?.recipe;
        if (!r) return;
        kcal    += Number(r.calories) || 0;
        protein += Number(r.protein)  || 0;
        carbs   += Number(r.carbs)    || 0;
        fat     += Number(r.fats)     || 0;
      });
      return { kcal: Math.round(kcal), protein: Math.round(protein), carbs: Math.round(carbs), fat: Math.round(fat) };
    }

    function renderSummary(data){
      const target = getTargetsFromProfile();
      const totals = computePlanTotals(data);
      summaryEl.innerHTML = `
        <div class="rounded-2xl p-5 shadow-md border border-[var(--sage)] bg-[var(--mint-green)]">
          <div class="grid sm:grid-cols-2">
            <div class="p-3">
              <p class="font-bold text-[var(--teal)] mb-1 text-base text-center">üéØ Target</p>
              <div class="flex flex-wrap gap-3 justify-center text-base leading-6">
                <span><strong>${target.kcal}</strong> kcal</span>
                <span><strong>${target.protein}</strong> g protein</span>
                <span><strong>${target.carbs}</strong> g carbs</span>
                <span><strong>${target.fat}</strong> g fat</span>
              </div>
            </div>
            <div class="p-3 border-t sm:border-t-0 sm:border-l border-[var(--sage)]">
              <p class="font-bold text-[var(--teal)] mb-1 text-base text-center">üìã Current Plan</p>
              <div class="flex flex-wrap gap-3 justify-center text-base leading-6">
                <span><strong>${totals.kcal}</strong> kcal</span>
                <span><strong>${totals.protein}</strong> g protein</span>
                <span><strong>${totals.carbs}</strong> g carbs</span>
                <span><strong>${totals.fat}</strong> g fat</span>
              </div>
            </div>
          </div>
        </div>`;
    }

    function badgeRow(pick){
      const chip = (c) => `<span class="inline-block bg-[var(--sage)]/60 text-[var(--teal)] text-[11px] font-semibold px-2 py-1 rounded-full">${c}</span>`;
      const subs = (pick.substitutes || []).map(s => chip('üîÅ '+s)).join(' ');
      const hidd = (pick.hidden || []).map(s => chip('üö´ '+s)).join(' ');
      const caut = (pick.cautions || []).map(s => chip('‚ö†Ô∏è '+s)).join(' ');
      return [subs, hidd, caut].filter(Boolean).join(' ');
    }

    function cardTpl(slot, pick){
      const r = pick.recipe;
      const tags = (r.tags || []).slice(0,3).map(
        t=>`<span class="inline-block bg-[var(--sage)] text-[var(--teal)] text-[11px] font-semibold px-2 py-1 rounded-full mr-1 mb-1">${t}</span>`
      ).join(' ');
      const badges = badgeRow(pick);
      return `
        <article class="bg-[var(--beige)] border border-[var(--sage)] rounded-2xl overflow-hidden flex flex-col shadow-sm hover:shadow-md transition-shadow">
          <img class="w-full h-40 object-cover bg-[var(--sage)]/30" src="${IMG_BASE}${r.image_url}" alt="${r.recipe_name}" loading="lazy">
          <div class="p-4 flex flex-col gap-3 flex-1">
            <div>
              <h3 class="text-lg font-bold">${slot}: ${r.recipe_name}</h3>
              <div class="flex flex-wrap gap-2 text-sm mt-1.5">
                <span>${r.calories} kcal</span>
                ${Number.isFinite(r.protein) ? `<span>${r.protein} g protein</span>` : ``}
                ${Number.isFinite(r.carbs)   ? `<span>${r.carbs} g carbs</span>`   : ``}
                ${Number.isFinite(r.fats)    ? `<span>${r.fats} g fat</span>`      : ``}
                <span>${r.time_minutes} min</span>
                <span>${r.dietaryType}</span>
              </div>
              ${tags ? `<div class="mt-2">${tags}</div>` : ``}
              ${badges ? `<div class="mt-2">${badges}</div>` : ``}
            </div>
            <div class="mt-auto">
              <a class="block text-center bg-[var(--peach)] text-white py-2 rounded-lg font-semibold shadow hover:bg-opacity-90 transition view-btn" href="#" data-slot="${slot}" data-slug="${r.slug}">
                View Recipe
              </a>
            </div>
          </div>
        </article>`;
    }

    function renderPlan(planData){
      const slots = ['Breakfast','Lunch','Snack','Dinner'];
      const cards = slots.map(s=>{
        const pick = planData.mealPlan?.[s];
        return pick?.recipe ? cardTpl(s,pick) : '';
      }).filter(Boolean);
      gridEl.innerHTML = cards.length ? cards.join('') : `<p class="text-center">No items returned.</p>`;
      renderSummary(planData);
    }

    function lockScroll(lock){ document.body.style.overflow = lock ? 'hidden' : ''; }
    function showRecipeModal({title, img, meta, ingredientsHtml, stepsHtml, notes}){
      const html = `
        <div class="modal-backdrop"></div>
        <div class="modal" role="dialog" aria-modal="true" aria-label="${title}">
          <button class="modal-close" aria-label="Close recipe">√ó</button>
          <h2 class="modal-title">${title}</h2>
          <img class="modal-img" src="${img}" alt="${title}">
          <p class="modal-meta">${meta}</p>
          <div class="modal-section">
            <h3 class="modal-subtitle">ü•ó Ingredients</h3>
            <ul class="modal-list">${ingredientsHtml}</ul>
          </div>
          <div class="modal-section">
            <h3 class="modal-subtitle">üë©‚Äçüç≥ Steps</h3>
            <ol class="modal-list numbered">${stepsHtml}</ol>
          </div>
          ${notes ? `<div class="modal-section">${notes}</div>` : ''}
        </div>`;
      const wrap = document.createElement('div');
      wrap.className = 'modal-wrap';
      wrap.innerHTML = html;
      document.body.appendChild(wrap);
      lockScroll(true);
      const close = () => { wrap.remove(); lockScroll(false); };
      wrap.querySelector('.modal-close').onclick = close;
      wrap.querySelector('.modal-backdrop').onclick = close;
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
    }

    gridEl.addEventListener('click', (e)=>{
      const a = e.target.closest('a.view-btn[data-slug][data-slot]');
      if(!a) return;
      e.preventDefault();
      if (!lastPlan) return;
      const slot = a.getAttribute('data-slot');
      const pick = lastPlan.mealPlan?.[slot];
      const item = pick?.recipe;
      if(!item) return alert('Recipe not found.');

      const ing = (item.ingredients||[]).map(i=>{
        const qty  = i.quantity ? `<strong>${i.quantity}</strong> ` : '';
        const name = toTitle(i.slug);
        const omit = i._hidden ? ' <em>(omitted)</em>' : '';
        let caut = '';
        if (i._caution) {
          const subsList = (i.caution_subs || []).map(s => toTitle(s)).join(', ');
          caut = subsList 
            ? ` <em>‚ö†Ô∏è caution ‚Äî consider replacing with: ${subsList}</em>` 
            : ` <em>‚ö†Ô∏è caution</em>`;
        }
        const sub  = i.substituted ? ` <em>üîÅ substitute: ${toTitle(i.substitute_slug)}</em>` : '';
        return `<li>${qty}${name}${omit}${caut}${sub}</li>`;
      }).join('');

      const steps = (item.steps||[]).map(s=>`<li>${clean(s)}</li>`).join('');
      const notes = item.notes ? `<p class="notes">${clean(item.notes)}</p>` : '';

      showRecipeModal({
        title: item.recipe_name,
        img: `${IMG_BASE}${item.image_url}`,
        meta: `<strong>${item.calories} kcal</strong> ‚Ä¢ ${item.protein ?? '-'} g protein ‚Ä¢ ${item.carbs ?? '-'} g carbs ‚Ä¢ ${item.fats ?? '-'} g fat ‚Ä¢ ${item.time_minutes} min ‚Ä¢ ${item.dietaryType}`,
        ingredientsHtml: ing,
        stepsHtml: steps,
        notes
      });
    });

    function profileToPayload() {
      if (!user.profile) return null;
      return {
        user: {
          gender: user.profile.gender,
          age: user.profile.age,
          height_cm: Math.round(user.profile.height || 0),
          weight_kg: Math.round(user.profile.weight || 0),
          activity: user.profile.activity,
          goal: user.profile.goal,
          food_preference: user.profile.dietaryType,
          dislikes: (user.profile.dislikes || 'none').split(',').map(s=>s.trim()).filter(Boolean),
          health_issues: (user.profile.health || 'none').split(',').map(s=>s.trim()).filter(Boolean)
        }
      };
    }

    function currentExcludeMapFromPlan(plan) {
      const map = {};
      if (!plan) return map;
      ['Breakfast','Lunch','Snack','Dinner'].forEach(slot=>{
        const slug = plan.mealPlan?.[slot]?.recipe?.slug;
        if (slug) map[slot] = [slug];
      });
      return map;
    }

    let recentSlugs = JSON.parse(localStorage.getItem('recentSlugs') || '{}');

    async function requestPlan(payload) {
      payload.recentSlugs = recentSlugs;
      const res = await fetch(MEALPLAN_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({ ok:false, message:'Invalid JSON' }));
      if (data.recentSlugs) {
        recentSlugs = data.recentSlugs;
        localStorage.setItem('recentSlugs', JSON.stringify(recentSlugs));
      }
      if (!res.ok || !data.ok) throw new Error(data.message || 'Failed to build meal plan');
      return data;
    }

    async function generateMealPlan(){
      if (!user.profile) {
        summaryEl.innerHTML = `<span class="block text-center">Please complete your profile on the Dashboard first.</span>`;
        gridEl.innerHTML = '';
        return;
      }
      statusEl.textContent = 'Generating‚Ä¶';
      gridEl.innerHTML = '';
      try{
        const payload = profileToPayload();
        payload.exclude = currentExcludeMapFromPlan(lastPlan);
        const data = await requestPlan(payload);
        lastPlan = data;
        renderPlan(data);
        statusEl.textContent = '';
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Failed to generate meal plan';
      }
    }

    async function swapSlot(slot){
      if (!user.profile) return;
      statusEl.textContent = `Changing ${slot}‚Ä¶`;
      try {
        const payload = profileToPayload();
        payload.exclude = currentExcludeMapFromPlan(lastPlan);
        const fresh = await requestPlan(payload);
        if (!lastPlan) lastPlan = fresh;
        if (fresh.mealPlan?.[slot]) {
          lastPlan.mealPlan[slot] = fresh.mealPlan[slot];
          renderPlan(lastPlan);
        } else {
          lastPlan = fresh;
          renderPlan(fresh);
        }
        statusEl.textContent = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Failed to change ${slot}`;
      }
    }

    document.getElementById('generateBtn').addEventListener('click', generateMealPlan);
    document.getElementById('swapBreakfast').addEventListener('click', ()=>swapSlot('Breakfast'));
    document.getElementById('swapLunch').addEventListener('click', ()=>swapSlot('Lunch'));
    document.getElementById('swapSnack').addEventListener('click', ()=>swapSlot('Snack'));
    document.getElementById('swapDinner').addEventListener('click', ()=>swapSlot('Dinner'));

    generateMealPlan();
  </script>
</body>
</html>
